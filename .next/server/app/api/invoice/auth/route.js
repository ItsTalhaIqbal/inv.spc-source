"use strict";(()=>{var e={};e.id=5095,e.ids=[5095],e.modules={11185:e=>{e.exports=require("mongoose")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},12781:e=>{e.exports=require("stream")},73837:e=>{e.exports=require("util")},77920:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>h,originalPathname:()=>Z,requestAsyncStorage:()=>g,routeModule:()=>c,serverHooks:()=>v,staticGenerationAsyncStorage:()=>f,staticGenerationBailout:()=>w});var s={};t.r(s),t.d(s,{POST:()=>POST}),t(78976);var a=t(10884),n=t(16132),i=t(96721),u=t.n(i),o=t(95798);let d=require("bcrypt");var l=t.n(d),p=t(8590),m=t(53470);async function POST(e){try{await (0,p.v)();let{username:r,email:t,password:s,role:a,action:n,token:i}=await e.json();if(!n)return o.Z.json({message:"Action is required"},{status:400});if("register"===n){if(!r||!t||!s)return o.Z.json({message:"Username, email and password are required"},{status:400});try{let e=await m.Z.findOne({username:r});if(e)return o.Z.json({message:"Username already taken"},{status:400});let n=await m.Z.findOne({email:t});if(n)return o.Z.json({message:"Email already taken"},{status:400});let i=await l().hash(s,12),u=new m.Z({username:r,email:t,password:i,role:a});return await u.save(),o.Z.json({message:"User created successfully"},{status:201})}catch(r){let e={message:"Error creating user",error:r.message};return o.Z.json(e,{status:500})}}if("login"===n){if(!r||!s)return o.Z.json({message:"Username and password are required"},{status:400});try{let e=await m.Z.findOne({username:r});if(!e)return o.Z.json({message:"Invalid username or password"},{status:400});let t=await l().compare(s,e.password);if(!t)return o.Z.json({message:"Invalid username or password"},{status:400});let a=u().sign({userId:e._id,username:e.username,role:e.role,email:e.email},process.env.JWT_SECRET||"default_secret",{expiresIn:"1h"});return o.Z.json({message:"Login successful",token:a},{status:200})}catch(r){let e={message:"Error during login",error:r.message};return o.Z.json(e,{status:500})}}if("tokenAuth"===n){if(!i)return o.Z.json({auth:!1,data:"No token found in request"},{status:401});try{let e=u().verify(i,process.env.JWT_SECRET||"default_secret");return o.Z.json({auth:!0,data:e},{status:200})}catch(e){return o.Z.json({auth:!1,data:"Invalid or expired token"},{status:401})}}return o.Z.json({message:"Invalid action"},{status:400})}catch(r){let e={message:"Internal server error",error:r.message};return o.Z.json(e,{status:500})}}let c=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/invoice/auth/route",pathname:"/api/invoice/auth",filename:"route",bundlePath:"app/api/invoice/auth/route"},resolvedPagePath:"C:\\Users\\Hammad\\Desktop\\checks\\Invoice_app\\app\\api\\invoice\\auth\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:g,staticGenerationAsyncStorage:f,serverHooks:v,headerHooks:h,staticGenerationBailout:w}=c,Z="/api/invoice/auth/route"},53470:(e,r,t)=>{t.d(r,{Z:()=>u});var s=t(11185),a=t.n(s);let n=new(a()).Schema({username:{type:String,required:!0,unique:!0},email:{type:String,required:!0,unique:!0},password:{type:String,required:!0},role:{type:String,required:!0,default:"salesman",enum:["admin","salesman"]},resetCode:{type:String,default:null},resetCodeExpiry:{type:Date,default:null}},{timestamps:!0}),i=a().models.User||a().model("User",n),u=i}};var r=require("../../../../webpack-runtime.js");r.C(e);var __webpack_exec__=e=>r(r.s=e),t=r.X(0,[4961,4933,6721,8590],()=>__webpack_exec__(77920));module.exports=t})();